import{aR as O,aM as E}from"./index-dcd728bc.js";var V={},v={};const F=(n,e)=>e.some(t=>n instanceof t);let T,B;function C(){return T||(T=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function N(){return B||(B=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const L=new WeakMap,x=new WeakMap,P=new WeakMap,g=new WeakMap,_=new WeakMap;function U(n){const e=new Promise((t,o)=>{const r=()=>{n.removeEventListener("success",s),n.removeEventListener("error",i)},s=()=>{t(u(n.result)),r()},i=()=>{o(n.error),r()};n.addEventListener("success",s),n.addEventListener("error",i)});return e.then(t=>{t instanceof IDBCursor&&L.set(t,n)}).catch(()=>{}),_.set(e,n),e}function z(n){if(x.has(n))return;const e=new Promise((t,o)=>{const r=()=>{n.removeEventListener("complete",s),n.removeEventListener("error",i),n.removeEventListener("abort",i)},s=()=>{t(),r()},i=()=>{o(n.error||new DOMException("AbortError","AbortError")),r()};n.addEventListener("complete",s),n.addEventListener("error",i),n.addEventListener("abort",i)});x.set(n,e)}let S={get(n,e,t){if(n instanceof IDBTransaction){if(e==="done")return x.get(n);if(e==="objectStoreNames")return n.objectStoreNames||P.get(n);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return u(n[e])},set(n,e,t){return n[e]=t,!0},has(n,e){return n instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in n}};function k(n){S=n(S)}function R(n){return n===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){const o=n.call(D(this),e,...t);return P.set(o,e.sort?e.sort():[e]),u(o)}:N().includes(n)?function(...e){return n.apply(D(this),e),u(L.get(this))}:function(...e){return u(n.apply(D(this),e))}}function q(n){return typeof n=="function"?R(n):(n instanceof IDBTransaction&&z(n),F(n,C())?new Proxy(n,S):n)}function u(n){if(n instanceof IDBRequest)return U(n);if(g.has(n))return g.get(n);const e=q(n);return e!==n&&(g.set(n,e),_.set(e,n)),e}const D=n=>_.get(n);function K(n,e,{blocked:t,upgrade:o,blocking:r,terminated:s}={}){const i=indexedDB.open(n,e),d=u(i);return o&&i.addEventListener("upgradeneeded",c=>{o(u(i.result),c.oldVersion,c.newVersion,u(i.transaction),c)}),t&&i.addEventListener("blocked",c=>t(c.oldVersion,c.newVersion,c)),d.then(c=>{s&&c.addEventListener("close",()=>s()),r&&c.addEventListener("versionchange",a=>r(a.oldVersion,a.newVersion,a))}).catch(()=>{}),d}function W(n,{blocked:e}={}){const t=indexedDB.deleteDatabase(n);return e&&t.addEventListener("blocked",o=>e(o.oldVersion,o)),u(t).then(()=>{})}const $=["get","getKey","getAll","getAllKeys","count"],H=["put","add","delete","clear"],I=new Map;function w(n,e){if(!(n instanceof IDBDatabase&&!(e in n)&&typeof e=="string"))return;if(I.get(e))return I.get(e);const t=e.replace(/FromIndex$/,""),o=e!==t,r=H.includes(t);if(!(t in(o?IDBIndex:IDBObjectStore).prototype)||!(r||$.includes(t)))return;const s=async function(i,...d){const c=this.transaction(i,r?"readwrite":"readonly");let a=c.store;return o&&(a=a.index(d.shift())),(await Promise.all([a[t](...d),r&&c.done]))[0]};return I.set(e,s),s}k(n=>({...n,get:(e,t,o)=>w(e,t)||n.get(e,t,o),has:(e,t)=>!!w(e,t)||n.has(e,t)}));const J=Object.freeze(Object.defineProperty({__proto__:null,deleteDB:W,openDB:K,unwrap:D,wrap:u},Symbol.toStringTag,{value:"Module"})),X=O(J);var p={};Object.defineProperty(p,"__esModule",{value:!0});p.constants=void 0;p.constants={DEFAULT_DEBOUNCE_TIME:0,DEFAULT_MAX_SIZE_IN_MB:2048,DEFAULT_OPENAI_MODEL:"text-embedding-ada-002",OPENAI_API_URL:"https://api.openai.com/v1/embeddings"};var h={};Object.defineProperty(h,"__esModule",{value:!0});h.debounce=h.getObjectSizeInMB=h.filterDocuments=void 0;function Z(n,e){let t=n;return e&&(e.include&&(t=t.filter(o=>A(o,e.include))),e.exclude&&(t=t.filter(o=>!A(o,e.exclude)))),t}h.filterDocuments=Z;function A(n,e){if(e.metadata){for(const t in e.metadata)if(n.metadata[t]!==e.metadata[t])return!1}return!(e.text&&!(Array.isArray(e.text)?e.text:[e.text]).includes(n.text))}function G(n){return JSON.stringify(n).length/1024/1024}h.getObjectSizeInMB=G;function Q(n,e){let t=null;return function(...o){const r=this;t&&clearTimeout(t),t=setTimeout(()=>n.apply(r,o),e)}}h.debounce=Q;var l=E&&E.__awaiter||function(n,e,t,o){function r(s){return s instanceof t?s:new t(function(i){i(s)})}return new(t||(t=Promise))(function(s,i){function d(m){try{a(o.next(m))}catch(f){i(f)}}function c(m){try{a(o.throw(m))}catch(f){i(f)}}function a(m){m.done?s(m.value):r(m.value).then(d,c)}a((o=o.apply(n,e||[])).next())})};Object.defineProperty(v,"__esModule",{value:!0});v.VectorStorage=void 0;const Y=X,b=p,M=h;class ee{constructor(e={}){var t,o,r,s;this.documents=[],this.maxSizeInMB=(t=e.maxSizeInMB)!==null&&t!==void 0?t:b.constants.DEFAULT_MAX_SIZE_IN_MB,this.debounceTime=(o=e.debounceTime)!==null&&o!==void 0?o:b.constants.DEFAULT_DEBOUNCE_TIME,this.openaiModel=(r=e.openaiModel)!==null&&r!==void 0?r:b.constants.DEFAULT_OPENAI_MODEL,this.embedTextsFn=(s=e.embedTextsFn)!==null&&s!==void 0?s:this.embedTexts,this.openaiApiKey=e.openAIApiKey,!this.openaiApiKey&&!e.embedTextsFn?console.error("VectorStorage: pass as an option either an OpenAI API key or a custom embedTextsFn function."):this.loadFromIndexDbStorage()}addText(e,t){return l(this,void 0,void 0,function*(){const o={metadata:t,text:e,timestamp:Date.now(),vector:[],vectorMag:0};return(yield this.addDocuments([o]))[0]})}addTexts(e,t){return l(this,void 0,void 0,function*(){if(e.length!==t.length)throw new Error("The lengths of texts and metadata arrays must match.");const o=e.map((r,s)=>({metadata:t[s],text:r,timestamp:Date.now(),vector:[],vectorMag:0}));return yield this.addDocuments(o)})}similaritySearch(e){return l(this,void 0,void 0,function*(){const{query:t,k:o=4,filterOptions:r,includeValues:s}=e,i=yield this.embedText(t),d=yield this.calculateMagnitude(i),c=(0,M.filterDocuments)(this.documents,r),f=this.calculateSimilarityScores(c,i,d).sort((y,j)=>j[1]-y[1]).slice(0,o).map(y=>Object.assign(Object.assign({},y[0]),{score:y[1]}));return this.updateHitCounters(f),f.length>0&&(this.removeDocsLRU(),yield this.saveToIndexDbStorage()),s||f.forEach(y=>{delete y.vector,delete y.vectorMag}),{query:{embedding:i,text:t},similarItems:f}})}initDB(){return l(this,void 0,void 0,function*(){return yield(0,Y.openDB)("VectorStorageDatabase",void 0,{upgrade(e){const t=e.createObjectStore("documents",{autoIncrement:!0,keyPath:"id"});t.createIndex("text","text",{unique:!0}),t.createIndex("metadata","metadata"),t.createIndex("timestamp","timestamp"),t.createIndex("vector","vector"),t.createIndex("vectorMag","vectorMag"),t.createIndex("hits","hits")}})})}addDocuments(e){return l(this,void 0,void 0,function*(){const t=e.filter(r=>!this.documents.some(s=>s.text===r.text));if(t.length===0)return[];const o=yield this.embedTextsFn(t.map(r=>r.text));return t.forEach((r,s)=>{r.vector=o[s],r.vectorMag=te(r)}),this.documents.push(...t),this.removeDocsLRU(),yield this.saveToIndexDbStorage(),t})}embedTexts(e){return l(this,void 0,void 0,function*(){const t=yield fetch(b.constants.OPENAI_API_URL,{body:JSON.stringify({input:e,model:this.openaiModel}),headers:{Authorization:`Bearer ${this.openaiApiKey}`,"Content-Type":"application/json"},method:"POST"});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return(yield t.json()).data.map(r=>r.embedding)})}embedText(e){return l(this,void 0,void 0,function*(){return(yield this.embedTextsFn([e]))[0]})}calculateMagnitude(e){return Math.sqrt(e.reduce((o,r)=>o+r*r,0))}calculateSimilarityScores(e,t,o){return e.map(r=>{const s=r.vector.reduce((d,c,a)=>d+c*t[a],0);let i=ne(s,r.vectorMag,o);return i=oe(i),[r,i]})}updateHitCounters(e){e.forEach(t=>{var o;t.hits=((o=t.hits)!==null&&o!==void 0?o:0)+1})}loadFromIndexDbStorage(){return l(this,void 0,void 0,function*(){this.db||(this.db=yield this.initDB()),this.documents=yield this.db.getAll("documents"),this.removeDocsLRU()})}saveToIndexDbStorage(){return l(this,void 0,void 0,function*(){this.db||(this.db=yield this.initDB());try{const e=this.db.transaction("documents","readwrite");yield e.objectStore("documents").clear();for(const t of this.documents)yield e.objectStore("documents").put(t);yield e.done}catch(e){console.error("Failed to save to IndexedDB:",e.message)}})}removeDocsLRU(){if((0,M.getObjectSizeInMB)(this.documents)>this.maxSizeInMB)for(this.documents.sort((e,t)=>{var o,r;return((o=e.hits)!==null&&o!==void 0?o:0)-((r=t.hits)!==null&&r!==void 0?r:0)||e.timestamp-t.timestamp});(0,M.getObjectSizeInMB)(this.documents)>this.maxSizeInMB;)this.documents.shift()}}v.VectorStorage=ee;function te(n){return Math.sqrt(n.vector.reduce((e,t)=>e+t*t,0))}function ne(n,e,t){return n/(e*t)}function oe(n){return(n+1)/2}(function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.VectorStorage=void 0;var e=v;Object.defineProperty(n,"VectorStorage",{enumerable:!0,get:function(){return e.VectorStorage}})})(V);export{V as d};
