import{_ as D,s as m,o,c,M as A,b as l,w as p,ae as $,O as T,d as V,z as b,a2 as B,aj as M,L as F,a as _,I as C,aI as y,R as x,F as k,a8 as E,x as w,aA as H,aB as L,y as P,aJ as N,aK as j}from"./index-dcd728bc.js";import{_ as q}from"./DynamicForm-d987c0fb.js";import{V as G}from"./VSheet-42154d36.js";import{d as S}from"./index-9159cc7e.js";import{C as R}from"./Chat-1fd8903b.js";const W={props:{inputItems:{type:Array,default:function(){return[]}}}},O={class:"input-group",style:{width:"100%"}},U={key:1},z={class:"d-flex justify-center"},K=V("No input fields available");function J(e,t,s,n,a,i){const d=m("v-subheader");return s.inputItems.length>0?(o(!0),c(F,{key:0},A(s.inputItems,u=>(o(),c("div",O,[l(M,null,{default:p(()=>[l($,{cols:"4"},{default:p(()=>[l(T,null,{default:p(()=>[V(b(u.name),1)]),_:2},1024)]),_:2},1024),l($,{cols:"8"},{default:p(()=>[l(B,{modelValue:u.value,"onUpdate:modelValue":v=>u.value=v},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]))),256)):(o(),c("div",U,[_("div",z,[l(d,{class:"text-center"},{default:p(()=>[K]),_:1})])]))}const Q=D(W,[["render",J]]);const f=C.createBackend(),X={props:{messages:Array},data(){return{filterMessages:[],defaultProfile:"@/assets/images/profile/1.jpg"}},components:{DynamicForm:q,DefaultForm:Q},created(){this.init()},methods:{init(){this.filterMessages=this.messages.map(e=>(e.open=!1,e.html=null,e.formData=null,e))},toolFormat(e){return e._item?e._item.tool.includes("formHandler")?"formHandler":e._item.tool:null},async openDescription(e){var t=this;t.$try({context:t,action:async()=>{const s=t.filterMessages[e]._item;if(t.filterMessages[e].open){t.filterMessages[e].open=!1;return}if(s.tool.includes("formHandler")){if(t.filterMessages[e].html&&t.filterMessages[e].formData){t.filterMessages[e].open=!0;return}let a=(await f.getWorkItem(s.taskId)).activity.variableForHtmlFormContext.name,i=s.tool.split(":")[1];t.filterMessages[e].html=await f.getRawDefinition(i,{type:"form"});let d=await f.getVariable(s.instId,a);t.filterMessages[e].formData=d?d.valueMap:{}}else{const n=await f.getWorkItem(s.taskId);let a=[];if(n.activity.parameters)for(const i of n.activity.parameters){let d=await f.getVariable(s.instId,i.variable.name);a.push({name:i.variable.name,value:d})}t.filterMessages[e].formData=a}t.filterMessages[e].open=!0}})},clickContent(e){this.$emit("clickMessage",e)},formatTime(e){var t=new Date(e),s=t.toString(),n=s.split(" ")[4].substring(0,5);return n}}},Y={class:"w-100"},Z=["src"],ee=["src"],te={key:0,style:{"font-size":"12px","padding-top":"20px"}},se={class:"w-100 pb-5"},ne=["innerHTML","onClick"],ae={key:0,style:{"margin-top":"20px"}},ie={key:0},oe={key:1},re={key:2},ce=["innerHTML"];function le(e,t,s,n,a,i){const d=m("Icon"),u=m("DynamicForm"),v=m("DefaultForm");return o(),c("div",Y,[y(e.$slots,"contents",{},()=>[(o(!0),c(F,null,A(a.filterMessages,(r,I)=>(o(),c("div",{key:I,class:"w-100"},[y(e.$slots,"messageProfile",{},()=>[l(M,{class:"ma-0 pa-0",style:{"margin-bottom":"10px !important"}},{default:p(()=>[l(x,{class:"pr-2",size:"40"},{default:p(()=>[r.profile?(o(),c("img",{key:1,src:r.profile,alt:"pro",width:"50"},null,8,ee)):(o(),c("img",{key:0,src:a.defaultProfile,alt:"pro",width:"50"},null,8,Z))]),_:2},1024),r.timeStamp?(o(),c("div",te,b(r.roleName)+" "+b(i.formatTime(r.timeStamp)),1)):k("",!0)]),_:2},1024)]),y(e.$slots,"messageContent",{},()=>[_("div",se,[l(G,{class:"bg-lightsecondary rounded-md px-3 py-2 w-100"},{default:p(()=>[l(M,{class:"pa-0 ma-0"},{default:p(()=>[_("div",{innerHTML:r.content,onClick:g=>i.clickContent(r)},null,8,ne),l(E),a.filterMessages[I].open?(o(),w(d,{key:0,onClick:g=>i.openDescription(I),icon:"iconamoon:arrow-up-2",width:"24",height:"24",style:{cursor:"pointer"}},null,8,["onClick"])):(o(),w(d,{key:1,onClick:g=>i.openDescription(I),icon:"iconamoon:arrow-down-2",width:"24",height:"24",style:{cursor:"pointer"}},null,8,["onClick"]))]),_:2},1024),r.open?(o(),c("div",ae,[i.toolFormat(r).includes("formHandler")?(o(),c("div",ie,[r.open?(o(),w(u,{key:0,class:"message-layout-dyna",formHTML:r.html,modelValue:r.formData,"onUpdate:modelValue":g=>r.formData=g},null,8,["formHTML","modelValue","onUpdate:modelValue"])):k("",!0)])):i.toolFormat(r)=="defaultHandler"?(o(),c("div",oe,[l(v,{inputItems:r.formData},null,8,["inputItems"])])):(o(),c("div",re,[_("div",{innerHTML:r.description},null,8,ce)]))])):k("",!0)]),_:2},1024)])])]))),128))]),y(e.$slots,"input")])}const we=D(X,[["render",le]]),de=C.createBackend();class pe extends H{constructor(t,s){super(t,s),this.previousMessages=[],this.input={answer:"",process_instance_id:"",process_definition_id:"",userInfo:t.userInfo,image:null}}beforeGenerate(t,s){if(t&&(t.text&&(this.input.answer=t.text),t.image&&(this.input.image=t.image)),s)this.client.processDefinition&&(this.input.process_definition_id=this.client.processDefinition),this.input.process_instance_id="new";else{var n=this.client.processInstance;this.input.activity_id=n.current_activity_ids[0],this.input.process_instance_id=n.proc_inst_id}}async generate(){const t=await de.start(this.input);this.client.onGenerationFinished(t)}}const h=C.createBackend(),ue={mixins:[L],components:{Chat:R},props:{isComplete:Boolean,isAgentMode:Boolean},data:()=>({processDefinition:null,processInstance:null,path:"proc_inst",organizationChart:[],chatInfo:null,onLoad:!1,bpmn:null,currentActivities:null,isRunningId:null}),computed:{chatName(){return this.processInstance&&this.processInstance.proc_inst_name?this.processInstance.proc_inst_name:""}},async created(){await this.init(),this.generator=new pe(this,{isStream:!0,preferredLanguage:"Korean"}),this.isAgentMode?this.chatInfo={title:"processExecution.cardTitle",text:"processExecution.agent"}:this.chatInfo={title:"processExecution.cardTitle",text:"processExecution.processDefinitionExplanation"}},mounted(){},beforeUnmount(){},watch:{$route:{deep:!0,async handler(e,t){e.params.taskId&&e.params.taskId!==t.params.taskId?(e.params.taskId||(this.messages=[]),await this.init()):e.params.instId&&e.params.instId!==t.params.instId&&await this.init()}}},methods:{async viewProcess(){},requestDraftAgent(e){var t=this;t.$try({context:t,action(){e&&(t.agentInfo.draftPrompt=e),t.messages.push(t.createMessageObj(e)),t.agentInfo.draftPrompt&&(t.agentInfo.isRunning=!0,t.requestAgent(t.agentInfo.draftPrompt))}})},async loadProcess(){this.onLoad=!1;let e,t;this.processInstance&&this.processInstance.current_activity_ids?(this.currentActivities=this.processInstance.current_activity_ids,e=this.processInstance.proc_inst_id,t=e.split(".")[0]):(e=this.$route.params.taskId,t=e.split(".")[0],this.processInstance=await h.getInstance(e),this.processInstance&&(this.currentActivities=this.processInstance.current_activity_ids));var s=await h.getRawDefinition(t,{type:"bpmn"});s&&(this.bpmn=s),this.onLoad=!0},async loadData(e){const t=this;t.$try({context:t,action:async()=>{t.processInstance=null,t.bpmn=null;let s;if(t.$route.params.taskId){const n=t.$route.params.taskId,a=await h.getWorkItem(n);a&&(s=a.worklist.instId)}else t.$route.params.instId&&(s=atob(t.$route.params.instId));if(s){const n=await h.getInstance(s);n&&(t.processInstance=n,t.checkDisableChat()),await t.loadProcess(),this.isAgentMode?(await t.loadAgentMessages(`proc_inst/${n.proc_inst_id}`,{key:"id"}),t.processInstanceId=n.proc_inst_id):await t.loadMessages(`proc_inst/${n.proc_inst_id}`,{key:"id"})}}})},checkDisableChat(){this.isComplete&&(this.disableChat=!0),this.processInstance&&this.processInstance.current_user_ids&&this.processInstance.current_user_ids.length>0&&!this.processInstance.current_user_ids.includes(this.userInfo.email)&&(this.disableChat=!0)},async beforeSendMessage(e){e&&e.text!=""&&(this.processInstance&&this.processInstance.proc_inst_id?this.generator.beforeGenerate(e,!1):this.generator.beforeGenerate(e,!0),this.sendMessage(e))},beforeSendEditedMessage(e){e>0&&(this.generator.beforeGenerate(this.messages[e-1].content,!1),this.sendEditedMessage(e))},async saveMessages(e){if(this.processInstance){var t=await this.getData(`${this.path}/${this.processInstance.proc_inst_id}`,{key:"id"});t.messages=e,await this.putObject(this.path,t)}},afterModelCreated(e){},afterGenerationFinished(e){var t=this;t.$try({context:t,async action(){let s=t.messages[t.messages.length-1];s.jsonContent=e;const n=e;n&&n.nextActivities&&n.nextActivities.length>0&&(s.content=n.nextActivities.map(a=>a.messageToUser).join(`

`)),t.processInstance=await h.getInstance(n.instanceId),t.checkDisableChat(),t.EventBus.emit("instances-updated"),t.EventBus.emit("process-definition-updated")}})},afterModelStopped(e){let t;if(this.$route.params.taskId?t=this.$route.params.taskId:this.processInstance&&this.processInstance.proc_inst_id&&(t=this.processInstance.proc_inst_id),t!=""){let s={messages:this.messages};this.putObject(`proc_inst/${t}`,s,{key:"id"})}},async sendNotification(e){const t={match:{id:this.userInfo.uid,email:this.userInfo.email}};let n=(await this.getData("users",t)).notifications;n||(n=[]);const a={id:e.instanceId,type:"instance",isChecked:!1};n.push(a);const i={id:this.userInfo.uid,notifications:n};this.putObject("users",i)},async saveDefinitionToVectorDB(){const e=await this.storage.list("proc_def");if(e&&e.length>0){const t=new S.VectorStorage({openAIApiKey:this.openaiToken});e.forEach(async s=>{if(s.definition){const n=JSON.stringify(s.definition);await t.addText(n,{category:s.definition.processDefinitionId})}})}},async queryFromVectorDB(e){const s=await new S.VectorStorage({openAIApiKey:this.openaiToken}).similaritySearch({query:e});return s.similarItems.length>0?s.similarItems.map(a=>a.text):(await this.saveDefinitionToVectorDB(),this.queryFromVectorDB(e))}}},fe=e=>(N("data-v-2dd5085d"),e=e(),j(),e),he={style:{"background-color":"rgba(255, 255, 255, 0)"}},me=fe(()=>_("div",null,null,-1));function _e(e,t,s,n,a,i){const d=m("Chat");return o(),c("div",he,[l(d,{messages:e.messages,agentInfo:e.agentInfo,chatInfo:e.chatInfo,isAgentMode:s.isAgentMode,userInfo:e.userInfo,disableChat:e.disableChat,type:"instances",name:i.chatName,onRequestDraftAgent:i.requestDraftAgent,onSendMessage:i.beforeSendMessage,onSendEditedMessage:i.beforeSendEditedMessage,onStopMessage:e.stopMessage},P({_:2},[e.$route.params.instId?{name:"custom-title",fn:p(()=>[me])}:void 0]),1032,["messages","agentInfo","chatInfo","isAgentMode","userInfo","disableChat","name","onRequestDraftAgent","onSendMessage","onSendEditedMessage","onStopMessage"])])}const be=D(ue,[["render",_e],["__scopeId","data-v-2dd5085d"]]);export{Q as D,be as P,we as W};
